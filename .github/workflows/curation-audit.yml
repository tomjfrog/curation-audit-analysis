name: Curation Audit Analysis

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches:
      - main
      - master
    paths:
      - 'main.py'

jobs:
  audit:
    runs-on: ubuntu-latest
    name: Generate Audit Report
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run curation audit analysis
        id: audit
        env:
          JF_URL: ${{ secrets.JF_URL }}
          JF_USER: ${{ secrets.JF_USER }}
          JF_PASSWORD: ${{ secrets.JF_PASSWORD }}
        run: python main.py 2>&1 | tee audit-output.txt

      - name: Debug - Show output
        run: |
          echo "First 100 lines of output:"
          head -100 audit-output.txt
          echo "---"
          echo "Last 100 lines of output:"
          tail -100 audit-output.txt
          
      - name: Generate Markdown report
        run: |
          # Extract JSON report from output
          
          # Parse JSON and generate Markdown
          python << 'EOF'
          import json
          import os
          import sys
          
          # Read the JSON report from the output
          with open('audit-output.txt', 'r') as f:
              content = f.read()
          
          # Find the JSON block by looking for the report structure
          # We'll look for lines with '{' that contain "approved"
          lines = content.split('\n')
          json_started = False
          json_lines = []
          brace_count = 0
          
          for line in lines:
              stripped = line.strip()
              # Start collecting when we see a line with '{' that has "approved" (could be at any indentation)
              if '{' in stripped and '"approved"' in stripped and not json_started:
                  json_started = True
                  brace_count = stripped.count('{') - stripped.count('}')
                  json_lines.append(line.rstrip())
              elif json_started:
                  json_lines.append(line.rstrip())
                  brace_count += stripped.count('{') - stripped.count('}')
                  # Stop when braces are balanced
                  if brace_count == 0 and len(json_lines) > 1:
                      break
          
          if not json_lines:
              print("No JSON report found")
              print("Output preview:")
              print(content[-500:])  # Show last 500 chars
              sys.exit(1)
          
          try:
              json_content = '\n'.join(json_lines)
              report = json.loads(json_content)
          except json.JSONDecodeError as e:
              print(f"Failed to parse JSON: {e}")
              print(f"JSON content: {json_content[:500]}")
              sys.exit(1)
          
          approved = report.get('approved', 0)
          blocked_total = report.get('blocked', {}).get('blocked_total', 0)
          policies = {k: v for k, v in report.get('blocked', {}).items() if k != 'blocked_total'}
          
          # Generate Markdown
          markdown = f"""# ðŸ“Š Curation Audit Report
          
          ## Summary
          
          - **Approved Packages**: {approved:,}
          - **Blocked Packages**: {blocked_total:,}
          
          ## Blocked Packages by Policy
          
          | Policy Name | Count |
          |-------------|-------|
          """
          
          # Sort policies by count descending
          sorted_policies = sorted(policies.items(), key=lambda x: x[1], reverse=True)
          for policy_name, count in sorted_policies:
              markdown += f"| {policy_name} | {count:,} |\n"
          
          total_policy_count = sum(policies.values())
          markdown += f"""
          > **Note**: Each package may be blocked by multiple policies, so the total blocked packages ({blocked_total:,}) and the sum of policy counts ({total_policy_count:,}) will not match.
          """
          
          # Write to job summary
          with open('$GITHUB_STEP_SUMMARY', 'w') as f:
              f.write(markdown)
          EOF
        env:
          GITHUB_STEP_SUMMARY: ${{ github.step_summary }}

